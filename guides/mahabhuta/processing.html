<!doctype html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width">
<title>Processing HTML DOM with Mahabhuta&apos;s Mahafuncs</title>
<meta name="pagename" content="Processing HTML DOM with Mahabhuta&apos;s Mahafuncs">
<meta name="date" content="Sat Dec 03 2016 22:08:52 GMT-0800 (PST)">
<meta name="DC.title" content="Processing HTML DOM with Mahabhuta&apos;s Mahafuncs">
<meta name="og:title" content="Processing HTML DOM with Mahabhuta&apos;s Mahafuncs">
<meta name="og:url" content="https://akashacms.com/guides/mahabhuta/processing.html">
<link rel="canonical" href="https://akashacms.com/guides/mahabhuta/processing.html">
<link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml">
<link rel="stylesheet" type="text/css" href="/vendor/bootstrap/css/bootstrap.min.css"><link rel="stylesheet" type="text/css" href="/vendor/bootstrap/css/bootstrap-theme.min.css"><link rel="stylesheet" type="text/css" href="/readable.min.css"><link rel="stylesheet" type="text/css" href="/style.css">
<style>
html, body {
    height:100%;
    max-height:100%;
    margin:0;
}

#page-container {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
}

#site-navbar {
    display: none;
    flex-shrink: 0;
    height: 30px;
}

#ebook-masthead {
    flex-shrink: 0;
    height: 60px;
}

#ebook-masthead h2 {
    font-size: 22px;
    margin-top: 0px;
}

#ebook-navigation {
    flex-shrink: 0;
    height: 60px;
}

#book-page-content {
    flex-grow: 1;
    overflow: auto;
    min-height: 2em;
}

#footer-row {
    display: none;
    flex-shrink: 0;
    height: 50px;
    background-color: grey;
}
</style>
</head>
<body class="ebook-page">
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
<button class="navbar-toggle" data-toggle="collapse" data-target=".navHeaderCollapse">
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<div class="navbar-collapse collapse navHeaderCollapse">
<ul class="nav navbar-nav navbar-rights">
<li><a href="/index.html">Home</a></li>
<li><a href="/install.html">Installation</a></li>
<li><a href="/configuration/index.html">Configuration</a></li>
<li><a href="/documents/index.html">Documents</a></li>
<li><a href="/plugins/index.html">Plugins</a></li>
<li><a href="/plugins/epub.html">AkashaEPUB</a></li>
<li><a href="/layout/index.html">Layouts</a></li>
<li><a href="/theming/index.html">Theming</a></li>
<li><a href="/deployment/index.html">Deployment</a></li>
<li><a href="/command-line/index.html">Command Line</a></li>
<li><a href="/howto/index.html">Tutorials</a></li>
<li><a href="/news/index.html">Blog</a></li>
<li><a href="/about.html">About</a></li>
</ul>
</div>
</div>
<div id="page-container">
<ebook-page-header id="ebook-masthead" header-height="60px"></ebook-page-header>
<div class="panel panel-default">
<ebook-navigation-header id="ebook-navigation" class="panel-heading"></ebook-navigation-header>
<div id="book-page-content" class="panel-body">
<div id="book-page-content" class="panel-body"><p>In the previous chapter we saw a simple one-element MahafuncArray. We were told that when running <code>mahabhuta.process</code> we&apos;re to pass in a MahafuncArray object. That&apos;s simple enough, right? An array of Mahafunc objects, yes?</p>
<h1>MahafuncArray - array&apos;s containing arrays containing arrays</h1>
<p>Of course it&apos;s not that simple. In AkashaCMS each Plugin is expected to have its own MahafuncArray filled with the Mahafunc&apos;s it supplies. Therefore a typical AkashaCMS project will have several MahafuncArray&apos;s to deal with.</p>
<p>To deal with that, Mahabhuta allows a MahafuncArray to contain other MahafuncArray instances, and of course these can be nested arbitrarily deep. It&apos;s kind of like that old Cosmological idea of Universe - that the land is resting on the back of a giant turtle, that&apos;s in turn standing on another turtle, that is in turn standing on another turtle. In Mahabhuta, it&apos;s MahafuncArray&apos;s all the way down to the bottom.</p>
<p>This means you can create a master MahafuncArray</p>
<pre><code>var mahamaster = new mahabhuta.MahafuncArray(&quot;master&quot;, {});
</code></pre>
<p>Then you add more MahafuncArray&apos;s for each group of Mahafunc&apos;s used in your application.</p>
<pre><code>mahamaster.addMahafunc(new mahabhuta.MahafuncArray(&quot;plugin-1&quot;, {}));
mahamaster.addMahafunc(new mahabhuta.MahafuncArray(&quot;plugin-2&quot;, {}));
</code></pre>
<p>And of course you can call <code>addMahafunc</code> on either of those MahafuncArray objects.</p>
<p>What&apos;s that second parameter? In the API it is marked as <code>config</code> but is currently ignored. It is meant to hold a configuration object for that MahafuncArray.</p>
<h2>Adding Mahafunc objects</h2>
<p>You of course don&apos;t just add MahafuncArray instances. The whole point to this is to define a list of operations we use to process HTML. We&apos;ve already seen this in the previous chapter. Generally speaking, we do this:</p>
<pre><code>class OurCustomElement extends mahabhuta.CustomElement {
	get elementName() { return &quot;our-custom-element&quot;; }
	process($element, metadata, dirty) {
		return Promise.resolve(&quot;Custom Element Content&quot;);
	}
}
mahamaster.addMahafunc(new OurCustomElement());
</code></pre>
<p>We add an instance of the class rather than the class. That is, we call <code>new OurClassName()</code> rather than just passing in <code>OurClassName</code>.</p>
<h2>The result: HTML in, changed HTML out</h2>
<p>The purpose for Mahabhuta is to manipulate HTML:</p>
<pre><code>mahabhuta.process(HTMLINPUT, { }, mahafuncs, (err, HTMLOUTPUT) =&gt; {
    if (err) console.error(err);
    else ...
});
</code></pre>
<p>The API follows the old-school callback model for backwards compatibility.</p>
<h2>Order of execution</h2>
<p>Each MahafuncArray and each Mahafunc within a MahafuncArray are executed in the order in which they&apos;re added. Later additions go to the end of the list, and are executed later than the earlier additions.</p>
<h2>Overriding a Mahafunc</h2>
<p>Suppose you&apos;re using a MahafuncArray providing a group of useful Mahafuncs, and you like the behavior of all but one. It&apos;s a wonderful set of Mahafunc&apos;s, but that one -- if only it were a little different. Mahabhuta allows you to override a Mahafunc simply by implementing a different version in an earlier MahafuncArray.</p>
<p>What did I mean by that? Typically your application uses multiple MahafuncArray&apos;s. If there are two Mahafunc&apos;s dealing with the same task, the one which executes first will take care of the task, and the one which executes later will not. Hence, the first one overrides the second.</p>
<p>This is <em>over-rideability principle</em>, meaning that every available action or template must be capable of being overridden.</p>
<p>For example, consider a second CustomElement Mahafunc for the <code>hello-world</code> tag we looked at earlier.</p>
<pre><code>var mahafuncs = new mahabhuta.MahafuncArray(&quot;example&quot;, {});

class HelloWorld extends mahabhuta.CustomElement {
	get elementName() { return &quot;hello-world&quot;; }
	process($element, metadata, dirty) {
		return Promise.resolve(&quot;Hello, happy world!&quot;);
	}
}
mahafuncs.addMahafunc(new HelloWorld());
</code></pre>
<p>Both of these declare they work on the <code>&lt;hello-world&gt;</code> tag. But when does the output say <code>Hello, world</code> and when does it say <code>Hello, happy world</code>? The answer depends on which is executed first. That&apos;s because a CustomElement Mahafunc replaces its tag with the result text (we&apos;ll go over this in a second).</p>
<p>One of those <code>&lt;hello-world&gt;</code> implementations will execute before the other. The first one to execute replaces <code>&lt;hello-world&gt;</code> with its text. When the second executes the tag is no longer there and the Mahafunc doesn&apos;t perform any work.</p>
<h1>The Mahafunc objects</h1>
<p>Currently there are two kinds of Mahafunc&apos;s, and a third type we might implement if it makes sense to do so. We&apos;ve already seen one, CustomElement, which is meant to process a single element in the DOM, replacing it with something else. The other, Munger, is meant for wider-ranging changes to the DOM.</p>
<p>Each sort of Mahafunc receives a jQuery-like object representing the DOM. It supports a subset of the jQuery API, supporting DOM manipulations using familiar jQuery methods.</p>
<h2>CustomElement</h2>
<p>We&apos;ve already looked at this object, without discussing any of the details. Let&apos;s do that now.</p>
<p>The <code>elementName</code> method is a getter, and it defines the name of the element provided by this CustomElement instance. As we saw in the Hello World example, with a CustomElement defined our HTML can contain a tag, <code>&lt;our-custom-element&gt;</code>. When Mahabhuta executes each CustomElement instance, it scans the DOM as if this were executed:</p>
<pre><code>var elements = [];
$(&apos;our-custom-element&apos;).each(function(i, elem) { ret.push(elem); });
</code></pre>
<p>For each element pushed to the <code>elements</code> array, Mahabhuta calls the <code>process</code> function. The <code>$element</code> parameter gets <code>$(element)</code>, and the <code>metadata</code> parameter is passed through unchanged.</p>
<p>The <code>dirty</code> parameter is a function you are to call if your CustomElement inserts HTML which requires further processing. You might add HTML that itself is meant to be processed by another Mahafunc. If that&apos;s the case, call <code>dirty()</code> in your function. If this function gets called, Mahabhuta will make sure to run all the Mahafunc&apos;s another time.</p>
<p>Your <code>process</code> function is to return a Promise that either resolve&apos;s or reject&apos;s depending on the result. If the Promise resolve&apos;s, it is to contain an HTML string you wish to replace the element. In Mahabhuta this is of course done as so:</p>
<pre><code>$(element).replaceWith(html);
</code></pre>
<p>Because the <code>process</code> function returns a Promise, you can make whatever asynchronous calls you like.</p>
<p>Bottom line: CustomElement objects are meant to implement, as the name implies, a custom HTML element which is completely replaced by other HTML code.</p>
<h3>Naming CustomElement implementations</h3>
<p>It&apos;s useful for your custom HTML elements to not collide with the regular HTML elements. Unless, that is, you want to override a regular HTML element with your custom implementation. For example you might want a CustomElement to replace old-school <code>&lt;i&gt;</code> or <code>&lt;b&gt;</code> tags with the new-school <code>&lt;em&gt;</code> and <code>&lt;strong&gt;</code> tags. But, normally, you&apos;ll want to leave the regular HTML tags alone, and ensure your custom tags do not collide.</p>
<p>A simple policy is to use the <code>-</code> character in the <code>elementName</code>. That&apos;s because all (or most) of the standard regular HTML elements do not have <code>-</code> in their element name.</p>
<p>Et voila, by using <code>-</code> in the <code>elementName</code> you&apos;re almost certainly assured of no naming collision.</p>
<p>Since there&apos;s an exception to every rule, the Mahabhuta built-in Mahafunc&apos;s does include a tag, <code>&lt;partial&gt;</code>, which does not follow this rule. Live with it, since <code>&lt;partial&gt;</code> is the best name for that tag.</p>
<h3>Data and parameters</h3>
<p>Being an HTML element, the HTML matching your CustomElement can of course have attributes.</p>
<pre><code>&lt;our-custom-element href=&quot;http://akashacms.com&quot;&gt;&lt;/our-custom-element&gt;
</code></pre>
<p>Which you can retrieve as so:</p>
<pre><code>process($element, metadata, dirty) {
    var href = $element.attr(&apos;href&apos;);
    ...
}
</code></pre>
<p>You can also retrieve metadata values:</p>
<pre><code>mahabhuta.process(htmlSource, {
    href: &quot;http://akashacms.com&quot;,
    title: &quot;AkashaCMS&quot;
}, mahafuncs, (err, html) =&gt; {
    if (err) console.error(err);
    else ...
});
</code></pre>
<p>Then access the values as so</p>
<pre><code>process($element, metadata, dirty) {
    ...
    var href = metadata.href;
    var title = metadata.title;
    ...
}
</code></pre>
<h2>Munger</h2>
<p>Munger objects are meant to implement broader changes to the HTML. For example you might want to &quot;clean up&quot; certain HTML code, or wrap certain code with some other HTML, or to insert some HTML elsewhere, or to move HTML from one place to another, and so forth. The jQuery API is powerful, and we want you to use all of it in processing HTML.</p>
<pre><code>class OurMungerClass extends mahabhuta.Munger {
	get selector() { return &quot;jQuery Selector&quot;; }

	process($, $match, metadata, dirty) {
    }
}
</code></pre>
<p>Instead of an element name, we&apos;re to supply a <code>selector</code>. This is a full normal jQuery-style selector so go wild with it.</p>
<p>For each match to the selector, the <code>process</code> function is called. The <code>metadata</code> and <code>dirty</code> parameters are as before.</p>
<p>The <code>$</code> parameter is the jQuery-like object representing the entire DOM. You can call any jQuery function on this object which Cheerio supports. While Cheerio supports a very large subset of jQuery, it has its limits.</p>
<p>The <code>$match</code> parameter is the <code>$(element)</code> entry that was scanned using the <code>selector</code>.</p>
<p>As before, the <code>process</code> function is to return a Promise. Unlike CustomElement, the content returned by the Promise is not used. You must of course indicate failure by rejecting the Promise, and success with the resolve method.</p>
<p>What you do within the <code>process</code> method is up to you. Have fun.</p>
<h2>A warning about dirty() infinite loops</h2>
<p>It&apos;s quite possible to lead Mahabhuta into an infinite loop:</p>
<pre><code>class InfiniteLoop extends mahabhuta.Munger {
	get selector() { return &quot;body&quot;; }

	process($, $match, metadata, dirty) {
        dirty();
        return Promise.resolve(&quot;infinite loop&quot;);
    }
}
</code></pre>
<p>Don&apos;t do this. Because Mahabhuta always ensures it&apos;ll re-run the Mahafunc&apos;s another time when <code>dirty</code> is called, this Mahafunc ensures Mahabhuta will never stop.</p>
<p>There are a number of ways to create such a situation.</p>
<h1>Backwards compatibility - adding bare functions and Array&apos;s</h1>
<p>For backwards compatibility with existing AkashaCMS code, Mahabhuta also supports adding simple function&apos;s (with a predefined signature), and simple Array&apos;s (which must contain Mahafunc&apos;s or the equivalent function).</p>
<p>The function signature is as so:</p>
<pre><code>mahafunc($, metadata, dirty, next);
</code></pre>
<p>These parameters are all as we&apos;ve seen above, except for <code>next</code>. This is an old style callback function supplied by Mahabhuta. You&apos;re to call it either as <code>next(error)</code> to indicate an error, or <code>next()</code> to indicate success.</p>
<p>When calling <code>mahabhuta.process</code> the <code>mahafuncs</code> parameter can be an Array. Internally this is converted to a MahafuncArray.</p>
</div>
<ebook-navigation-header id="ebook-navigation-bottom" class="panel-heading"></ebook-navigation-header>
<div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'akashacms'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
</div>
<footer id="footer-row" class="container">
<div class="fb-like-box" data-href="http://www.facebook.com/Akashacms" data-width="125" data-height="250" data-show-faces="false" data-stream="false" data-header="true"></div>
</footer>
</div>
<script src="/vendor/jquery/jquery.min.js"></script><script src="/vendor/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript">
var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-37003917-1']);
  _gaq.push(['_setDomainName', 'akashacms.com']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</html>
